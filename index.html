<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Ponto Digital</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="bg-white p-6 rounded-xl shadow-md w-full max-w-3xl">
    <h1 class="text-2xl font-bold mb-4 text-center">Controle de Ponto</h1>

    <!-- Botões de registro -->
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="registerEntry('in')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Entrada</button>
      <button onclick="registerEntry('out')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Saída</button>
    </div>

    <!-- Saldo Mensal -->
    <div class="text-center mb-6">
      <span class="text-gray-700">Saldo Mensal: </span>
      <span id="monthlyBalance" class="font-bold">00:00</span>
    </div>

    <!-- Histórico -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Histórico de Registros</h2>
      <ul id="historyList" class="divide-y divide-gray-200"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "SEU_ID",
      appId: "SUA_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let entries = [];
    let approvedRequests = []; // simulação para abonos

    // Função para registrar entrada/saída
    async function registerEntry(type) {
      const timestamp = new Date();
      await addDoc(collection(db, "ponto"), {
        type,
        timestamp
      });
      await loadEntries();
    }

    // Carregar registros
    async function loadEntries() {
      const querySnapshot = await getDocs(collection(db, "ponto"));
      entries = [];
      querySnapshot.forEach((doc) => {
        entries.push({ id: doc.id, ...doc.data() });
      });
      renderHistory();
    }

    // Formatar tempo (hh:mm)
    function formatMilliseconds(ms, withSign = false) {
      const sign = ms < 0 ? "-" : (withSign ? "+" : "");
      const absMs = Math.abs(ms);
      const hours = Math.floor(absMs / (1000 * 60 * 60));
      const minutes = Math.floor((absMs % (1000 * 60 * 60)) / (1000 * 60));
      return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    // Renderizar histórico
    function renderHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';

      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      let totalMonthlyBalanceMs = 0;

      for (let i = 0; i < 30; i++) {
        const dateObj = new Date(today);
        dateObj.setDate(today.getDate() - i);
        const dateStr = dateObj.toLocaleDateString('pt-BR');

        const dayEntries = { ins: [], outs: [] };
        entries.forEach(entry => {
          const entryDate = new Date(entry.timestamp.seconds * 1000);
          if (entryDate.toLocaleDateString('pt-BR') === dateStr) {
            if (entry.type === 'in') {
              dayEntries.ins.push({ timestamp: entryDate });
            } else {
              dayEntries.outs.push({ timestamp: entryDate });
            }
          }
        });

        let statusText = '';
        let statusColor = '';
        let balanceText = '';
        let balanceClass = '';

        const weekday = dateObj.getDay();
        const isWeekend = (weekday === 0 || weekday === 6);
        const isWorkday = !isWeekend;

        // Abono aprovado
        const approvedRequest = approvedRequests.some(r =>
          r.startDate.toDate().toLocaleDateString('pt-BR') === dateStr ||
          (r.startDate.toDate() < dateObj && r.endDate.toDate() >= dateObj)
        );

        if (approvedRequest) {
          statusText = 'Abonada';
          statusColor = 'text-green-500';
          balanceText = '00:00';
          balanceClass = 'text-green-600';

        } else if (isWorkday && dateObj < today && dayEntries.ins.length === 0 && dayEntries.outs.length === 0) {
          statusText = 'Falta';
          statusColor = 'text-red-500';
          balanceText = '-06:00';
          balanceClass = 'text-red-600';
          if (dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear) {
            totalMonthlyBalanceMs -= (6 * 3600 * 1000);
          }

        } else if (dayEntries.ins.length > 0 && dayEntries.ins.length > dayEntries.outs.length) {
          // Dia em andamento → calcula tempo desde a primeira entrada até agora
          const sortedIns = dayEntries.ins.sort((a, b) => a.timestamp - b.timestamp);
          const firstIn = sortedIns[0].timestamp;
          const workedSoFar = today - firstIn;

          statusText = 'Em andamento';
          statusColor = 'text-blue-500';
          balanceText = formatMilliseconds(workedSoFar, false);
          balanceClass = 'text-blue-600';

        } else if (dayEntries.ins.length > 0 && dayEntries.ins.length === dayEntries.outs.length) {
          // Dia completo → calcula saldo
          let dailyWorkedMs = 0;
          const sortedIns = dayEntries.ins.sort((a,b) => a.timestamp - b.timestamp);
          const sortedOuts = dayEntries.outs.sort((a,b) => a.timestamp - b.timestamp);
          for (let i = 0; i < sortedIns.length; i++) {
            dailyWorkedMs += sortedOuts[i].timestamp - sortedIns[i].timestamp;
          }
          const dailyBalanceMs = dailyWorkedMs - (6 * 3600 * 1000);
          const isTolerated = Math.abs(dailyBalanceMs) <= (15 * 60 * 1000);
          balanceText = isTolerated ? '00:00' : formatMilliseconds(dailyBalanceMs, true);
          balanceClass = isTolerated ? 'text-gray-800' : dailyBalanceMs > 0 ? 'text-green-600' : 'text-red-600';
          if (!isTolerated && dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear) {
            totalMonthlyBalanceMs += dailyBalanceMs;
          }
          statusText = 'Concluído';
          statusColor = 'text-green-500';
        } else {
          statusText = isWeekend ? 'Fim de semana' : '';
          statusColor = 'text-gray-500';
          balanceText = '';
          balanceClass = 'text-gray-500';
        }

        const li = document.createElement('li');
        li.className = 'flex justify-between items-center py-2 border-b border-gray-200';
        li.innerHTML = `
          <span class="font-medium ${statusColor}">${dateStr} - ${statusText}</span>
          <span class="${balanceClass}">${balanceText}</span>
        `;
        historyList.appendChild(li);
      }

      document.getElementById('monthlyBalance').textContent = formatMilliseconds(totalMonthlyBalanceMs, true);
    }

    // Inicializar carregamento
    loadEntries();
  </script>
</body>
</html>
